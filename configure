#!/usr/bin/env bash

set -ueo pipefail

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Flag to control fetching
NO_FETCH=0

# Parse command-line arguments
for arg in "$@"; do
  if [ "$arg" = "--no-fetch" ]; then
    NO_FETCH=1
  else
    echo "Invalid option: $arg" >&2
    exit 1
  fi
done

function log() {
  echo "$1" > /dev/stderr
}

function ignore_comments() {
  grep -vE '^#|^$' "$@"
}

log "Copying files"
cp "$SCRIPT_DIR/config.json" .
cp "$SCRIPT_DIR/index.html" .

mkdir -p facts/inflation
cp "$SCRIPT_DIR/facts/inflation/"* facts/inflation

mkdir -p facts/exchange-rates

if test "$NO_FETCH" -eq 0; then
  log "Fetching EUR-USD exchange rates"
  (
    echo "date,rate"
    curl -s -g 'https://www.ecb.europa.eu/stats/policy_and_exchange_rates/euro_reference_exchange_rates/html/usd.xml' | \
      grep Obs | \
      sed 's/<Obs TIME_PERIOD="//; s/" OBS_VALUE="/,/; s/" OBS_STA.*//'
  ) > facts/exchange-rates/eur-usd.csv

  log "Fetching MSCI indexes"
  ignore_comments "$SCRIPT_DIR/"data/interesting-indexes/msci.csv | "$SCRIPT_DIR/scripts/fetch-msci-indexes.py"

  log "Fetching indexes from Wall Street Journal"
  ignore_comments "$SCRIPT_DIR/"data/interesting-indexes/wall-street-journal.csv | "$SCRIPT_DIR/scripts/fetch-indexes-from-wsj.py" 57494d5ed7ad44af85bc59a51dd87c90

  log "Fetching indexes from zonebourse"
  ignore_comments "$SCRIPT_DIR/"data/interesting-indexes/zonebourse.csv | "$SCRIPT_DIR/scripts/fetch-indexes-from-zonebourse.py"

  log "Fetching ETFs"
  ignore_comments facts/indexes.csv | "$SCRIPT_DIR/scripts/fetch-etfs.py" > facts/etfs.csv

  # Generate null index
  EARLIEST_INDEX=$(sort -t, -k5 facts/indexes.csv | grep -v null | head -n1 | cut -f1 -d,)
  EARLIEST_DATE=$(sort -t, -k5 facts/indexes.csv | grep -v null | head -n1 | cut -f5 -d,)
  sed '2,$ s/,.*/,1/' 'facts/indexes/'"$EARLIEST_INDEX"'.csv' > facts/indexes/null.csv
  echo "null,Null Index,null,USD,$EARLIEST_DATE,https://dev.null" >> facts/indexes.csv
fi


# Initialize the build.ninja file
log "Generating build.ninja..."

INDICES=""
INDICES_CSVS=""
for CSV_FILE in facts/indexes/*.csv; do
    INDICES="$INDICES \"$(basename "$CSV_FILE" .csv)\""
    INDICES_CSVS="$INDICES_CSVS $CSV_FILE"
done

# Start the ninja file with the rule for creating .json files
cat <<EOF > build.ninja
# Ninja build file generated by script
rule generate_kde
  command=$SCRIPT_DIR/scripts/simulate.py '\$INDEX' --hold \$HOLD --years \$YEARS \$ADJUST_CURRENCY \$ADJUST_INFLATION
  description=Generating KDE for \$in -> \$out

rule compute_correlation
  command=$SCRIPT_DIR/scripts/compute-correlation.py \$INDICES > \$out
  description=Producing correlation data in \$out

build facts/indexes-correlation.csv: compute_correlation$INDICES_CSVS
  INDICES=$INDICES

EOF

function emit_build() {
    BASE_NAME="$1"
    shift
    HOLD="$1"
    shift
    YEARS="$1"
    shift
    ADJUST_CURRENCY="$1"
    shift
    ADJUST_INFLATION="$1"
    shift

    OUTPUT_JSON="simulations"
    OUTPUT_JSON+="/${BASE_NAME}"
    OUTPUT_JSON+="/hold-${HOLD}"
    OUTPUT_JSON+="/years-${YEARS}"
    if test -z "$ADJUST_CURRENCY"; then OUTPUT_JSON+="/adjust-currency"; else OUTPUT_JSON+="/ignore-currency"; fi
    if test -z "$ADJUST_INFLATION"; then OUTPUT_JSON+="/adjust-inflation"; else OUTPUT_JSON+="/ignore-inflation"; fi
    OUTPUT_JSON+="/kde.json"

    # Append the build target to the ninja file
    {
      echo "build $OUTPUT_JSON: generate_kde $CSV_FILE"
      echo "  YEARS = $YEARS"
      echo "  HOLD = $HOLD"
      echo "  INDEX = $BASE_NAME"
      echo "  ADJUST_CURRENCY = $ADJUST_CURRENCY"
      echo "  ADJUST_INFLATION = $ADJUST_INFLATION"
    } >> build.ninja
}

for ADJUST_CURRENCY in "" "--ignore-currency"; do
  for ADJUST_INFLATION in "" "--ignore-inflation"; do
    # Find all CSV files in facts/indexes/*-*.csv
    for CSV_FILE in facts/indexes/*.csv; do
      # Extract the base name of the CSV (e.g., myfile-123.csv -> myfile-123)
      BASE_NAME=$(basename "$CSV_FILE" .csv)

      for YEARS in 10 15 20 25 max; do
        emit_build "$BASE_NAME" 1.0 "$YEARS" "$ADJUST_CURRENCY" "$ADJUST_INFLATION"
        emit_build "$BASE_NAME" 3.0 "$YEARS" "$ADJUST_CURRENCY" "$ADJUST_INFLATION"
        emit_build "$BASE_NAME" 5.0 "$YEARS" "$ADJUST_CURRENCY" "$ADJUST_INFLATION"
        if test "$YEARS" != 10; then
          emit_build "$BASE_NAME" 10.0 "$YEARS" "$ADJUST_CURRENCY" "$ADJUST_INFLATION"
        fi
      done
    done
  done
done

log "build.ninja file has been generated."
